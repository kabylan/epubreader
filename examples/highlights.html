<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>EPUB.js Highlights Example</title>

  <!-- CSS only -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
  <!-- JavaScript Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>

  <!--fontawesome-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" integrity="sha512-HK5fgLBL+xu6dm/Ii3z4xhlSUyZgTT9tuc/hSrtw6uzJOvgRr2a9jyxxT1ely+B+xFAmJKVSTbpM/CuL7qxO8w==" crossorigin="anonymous" />

  <!--roboto-->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300&display=swap" rel="stylesheet">

  <!--mdbootstrap-->
  <link rel="stylesheet" href="https://unpkg.com/bootstrap-material-design@4.1.1/dist/css/bootstrap-material-design.min.css" integrity="sha384-wXznGJNEXNG1NFsbm0ugrLFMQPWswR3lds2VeinahP8N0zJw9VWSopbjv2x7WCvX" crossorigin="anonymous">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
  <script src="../dist/epub.js"></script>
  <link rel="stylesheet" type="text/css" href="examples.css">

  

  <style type="text/css">
  
    ::selection {
      background: yellow;
    }

    #extras {
      width: 600px;
      margin: 40px auto;
    }

    #highlights {
      list-style: none;
      margin-left: 0;
      padding: 0;
    }

    #highlights li {
      list-style: none;
      margin-bottom: 20px;
      border-top: 1px solid #E2E2E2;
      padding: 10px;
    }

    #highlights a {
      display: block;
    }

    #viewer.spreads {
      top: 0;
      margin-top: 50px;
    }

    [ref="epubjs-mk"] {
      background: url("data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPScxLjEnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZycgeG1sbnM6eGxpbms9J2h0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsnIHg9JzBweCcgeT0nMHB4JyB2aWV3Qm94PScwIDAgNzUgNzUnPjxnIGZpbGw9JyNCREJEQkQnIGlkPSdidWJibGUnPjxwYXRoIGNsYXNzPSdzdDAnIGQ9J00zNy41LDkuNEMxOS42LDkuNCw1LDIwLjUsNSwzNC4zYzAsNS45LDIuNywxMS4zLDcuMSwxNS42TDkuNiw2NS42bDE5LTcuM2MyLjgsMC42LDUuOCwwLjksOC45LDAuOSBDNTUuNSw1OS4yLDcwLDQ4LjEsNzAsMzQuM0M3MCwyMC41LDU1LjQsOS40LDM3LjUsOS40eicvPjwvZz48L3N2Zz4=") no-repeat;
      width: 20px;
      height: 20px;
      cursor: pointer;
      margin-left: 0;
    }

  </style>
</head>
<body>
  
  <div class="bmd-layout-container bmd-drawer-f-l bmd-drawer-overlay pb-0">
    <header class="bmd-layout-header p-0 m-0">
      <div class="navbar navbar-light bg-faded">

        <button class="navbar-toggler btn btn-link" type="button" data-toggle="drawer" data-target="#dw-s1">
          <span class="sr-only">Toggle drawer</span>
          <i class="fas fa-chevron-left" id='bookName'> Название книги</i>
        </button>
        <div>
            <button type="button" class="btn btn-link" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
              <i class="fas fa-cog"></i>
            </button>
            
            <button class="btn btn-link">
              <i class="fas fa-list-ul"></i>
            </button>
            <button class="btn btn-link">
              <i class="fas fa-expand"></i>
            </button>
            <button class="btn btn-link">
              <i class="far fa-question-circle"></i>
            </button>
        </div>
        
      </div>
    </header>
    <div id="dw-s1" class="bmd-layout-drawer bg-faded m-0">
      <header>
        <a class="navbar-brand">Содержание</a>
      </header>
      <ul id="bookContent" class="list-group">
      
        <!-- <li class="list-group-item list-group-item-action" data-url='chapter_120.xhtml' onclick="rendition.display(this.getAttribute('data-url'));">a</li>
        <li class="list-group-item list-group-item-action" data-url='chapter_120.xhtml' onclick="rendition.display(this.getAttribute('data-url'));">a</li>
        <li class="list-group-item list-group-item-action" data-url='chapter_120.xhtml' onclick="rendition.display(this.getAttribute('data-url'));">a</li>
       -->
      </ul>

    </div>
    <main class="bmd-layout-content">
        <!-- <nav class="navbar navbar-expand-lg navbar-light bg-info">
          <div class="container-fluid">
            <div class="collapse navbar-collapse" id="navbarNav">
      
              <a class="nav-link" href="#">
                <i class="fas fa-chevron-left"> Название книги</i>
              </a>
              <ul class="navbar-nav">
                <li class="nav-item">
                  <a class="nav-link " href="#">
                    <i class="fas fa-cog"></i>
                  </a>
                </li>
                <li class="nav-item">
                  <a class="nav-link " href="#">
                    <i class="fas fa-list-ul"></i>
                  </a>
                </li>
                <li class="nav-item">
                  <a class="nav-link " href="#">
                    <i class="fas fa-expand"></i>
                  </a>
                </li>
                <li class="nav-item">
                  <a class="nav-link " href="#">
                    <i class="far fa-question-circle"></i>
                  </a>
                </li>
      
              </ul>
            </div>
      
      
          </div>
        </nav> -->
        <div id="frame p-0">
          <div id="viewer" class="spreads mt-1"></div>
          <a id="prev" href="#prev" class="arrow">‹</a>
          <a id="next" href="#next" class="arrow">›</a>
        </div>
        <div id="extras">
          <ul id="highlights"></ul>
        </div>





    </main>
  </div>



        <!--MODAL-->

        <!-- Modal -->
        <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <!-- <h5 class="modal-title" id="staticBackdropLabel">Настройки</h5> -->
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                  <!--Color of text and background color-->
                  <div class="p-2">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="concantraintSwitch">
                      <label class="form-check-label" for="concantraintSwitch"> Режим высокой концентрации</label>
                    </div>
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="nightmodeSwitch">
                      <label class="form-check-label" for="nightmodeSwitch"> Нойчной режим</label>
                    </div>
                  </div>
              </div>
            </div>
          </div>
        </div>



  <script>
    // Load the opf
    //var book = ePub("https://s3.amazonaws.com/moby-dick/OPS/package.opf", { openAs: "opf" });
    var book = ePub("http://files.infogridpacific.com/epub3/don-quijoti-epub3.epub", { openAs: "epub" });
    
    
    
    var rendition = book.renderTo("viewer", {
      width: "100%",
      height: 600,
      ignoreClass: 'annotator-hl',
      manager: "continuous",
    });

    var displayed = rendition.display(6);

    book.loaded.navigation.then(function(toc){
			var $ul = document.getElementById("bookContent"),
					docfrag = document.createDocumentFragment();

      var isBookName = true;
			toc.forEach(function(chapter) {

        if (chapter.subitems.length > 0) {
          console.log(chapter.subitems[0].label);

          chapter.subitems.forEach(function(subitem) {
              var li = document.createElement("li");
              li.textContent = subitem.label;
              li.dataset.url = subitem.href;
              li.classList.add('list-group-item'); 
              li.classList.add('list-group-item-action'); 
              li.addEventListener('click', function(){
                  rendition.display(li.getAttribute('data-url'));
              });
              docfrag.appendChild(li);
          });

        }

        if (isBookName) {
          document.getElementById('bookName').textContent = " " + chapter.label;
          isBookName = false;
        }

        var li = document.createElement("li");
				li.textContent = chapter.label;
				li.dataset.url = chapter.href;
        li.classList.add('bg-secondary');
        li.classList.add('text-light');
        li.classList.add('list-group-item'); 
        li.classList.add('list-group-item-action'); 
        li.addEventListener('click', function(){
            rendition.display(li.getAttribute('data-url'));
        });
        docfrag.appendChild(li);
			});

			$ul.appendChild(docfrag);



			// $select.onchange = function(){
			// 		var index = $select.selectedIndex,
			// 				url = $select.options[index].ref;
			// 		rendition.display(url);
			// 		return false;
			// };

		});


    var next = document.getElementById("next");
    next.addEventListener("click", function(){
      rendition.next();
    }, false);

    var prev = document.getElementById("prev");
    prev.addEventListener("click", function(){
      rendition.prev();
    }, false);

    var keyListener = function(e){

      // Left Key
      if ((e.keyCode || e.which) == 37) {
        rendition.prev();
      }

      // Right Key
      if ((e.keyCode || e.which) == 39) {
        rendition.next();
      }

    };

    rendition.on("keyup", keyListener);
    document.addEventListener("keyup", keyListener, false);


    rendition.on("relocated", function(location){
      // console.log(location);

      var next = book.package.metadata.direction === "rtl" ?  document.getElementById("prev") : document.getElementById("next");
      var prev = book.package.metadata.direction === "rtl" ?  document.getElementById("next") : document.getElementById("prev");

      if (location.atEnd) {
        next.style.visibility = "hidden";
      } else {
        next.style.visibility = "visible";
      }

      if (location.atStart) {
        prev.style.visibility = "hidden";
      } else {
        prev.style.visibility = "visible";
      }

    });

    // Apply a class to selected text
    rendition.on("selected", function(cfiRange, contents) {
      rendition.annotations.highlight(cfiRange, {}, (e) => {
        // console.log("highlight clicked", e.target);
      });
      contents.window.getSelection().removeAllRanges();

    });

    this.rendition.themes.default({
      '::selection': {
        'background': 'rgba(255,255,0, 0.3)'
      },
      '.epubjs-hl' : {
        'fill': 'yellow', 'fill-opacity': '0.3', 'mix-blend-mode': 'multiply'
      }
    });

    // Illustration of how to get text from a saved cfiRange
    var highlights = document.getElementById('highlights');

    rendition.on("selected", function(cfiRange) {

      book.getRange(cfiRange).then(function (range) {
        var text;
        var li = document.createElement('li');
        var a = document.createElement('a');
        var remove = document.createElement('a');
        var textNode;

        if (range) {
          text = range.toString();
          textNode = document.createTextNode(text);

          a.textContent = cfiRange;
          a.href = "#" + cfiRange;
          a.onclick = function () {
            rendition.display(cfiRange);
          };

          remove.textContent = "remove";
          remove.href = "#" + cfiRange;
          remove.onclick = function () {
            rendition.annotations.remove(cfiRange);
            return false;
          };

          // li.appendChild(a);
          // li.appendChild(textNode);
          // li.appendChild(remove);
          // highlights.appendChild(li);
        }

      })

    });

    /*change color and background of text */
    var concantraintSwitch = document.getElementById("concantraintSwitch");
    concantraintSwitch.addEventListener("click", function(){
      
      if (concantraintSwitch.checked) {
        document.querySelector('body').classList.add('bg-dark');
      } else {
        document.querySelector('body').classList.remove('bg-dark');
      }
    }, false);

    var nightmodeSwitch = document.getElementById("nightmodeSwitch");
    nightmodeSwitch.addEventListener("click", function(){
      
      if (nightmodeSwitch.checked) {
        rendition.themes.default({ "body": { "background": "#222", "color": "#ddd", "box-shadow": "none"}})
      } else {
        rendition.themes.default({ "body": { "background": "#eee", "color": "#000", "box-shadow": "none"}})
      }
    }, false);

  </script>

<!--mdbootstrap-->
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://unpkg.com/popper.js@1.12.6/dist/umd/popper.js" integrity="sha384-fA23ZRQ3G/J53mElWqVJEGJzU0sTs+SvzG8fXVWP+kJQ1lwFAOkcUOysnlKJC33U" crossorigin="anonymous"></script>
<script src="https://unpkg.com/bootstrap-material-design@4.1.1/dist/js/bootstrap-material-design.js" integrity="sha384-CauSuKpEqAFajSpkdjv3z9t8E7RlpJ1UP0lKM/+NdtSarroVKu069AlsRPKkFBz9" crossorigin="anonymous"></script>
<script>$(document).ready(function() { $('body').bootstrapMaterialDesign(); });</script>

</body>
</html>
